(function(b){function r(){var a=b('<style id="__dragtable_disable_text_selection__" type="text/css">body { -ms-user-select:none;-moz-user-select:-moz-none;-khtml-user-select:none;-webkit-user-select:none;user-select:none; }</style>');b(document.head).append(a);b(document.body).attr("onselectstart","return false;").attr("unselectable","on");window.getSelection?window.getSelection().removeAllRanges():document.selection.empty()}function l(a,b){var c=a.parentNode,f=a.nextSibling===b?a:a.nextSibling;b.parentNode.insertBefore(a,
b);c.insertBefore(b,f)}b.widget("akottr.dragtable",{options:{revert:!1,dragHandle:".table-handle",maxMovingRows:40,excludeFooter:!1,onlyHeaderThreshold:100,dragaccept:null,persistState:null,restoreState:null,clickDelay:10,containment:null,cursor:"move",cursorAt:!1,distance:0,tolerance:"pointer",axis:"x",beforeStart:b.noop,beforeMoving:b.noop,beforeReorganize:b.noop,beforeStop:b.noop},originalTable:{el:null,selectedHandle:null,sortOrder:null,startIndex:0,endIndex:0},sortableTable:{el:b(),selectedHandle:b(),
movingRow:b()},persistState:function(){var a=this;this.originalTable.el.find("th").each(function(b){""!==this.id&&(a.originalTable.sortOrder[this.id]=b)});b.ajax({url:this.options.persistState,data:this.originalTable.sortOrder})},_restoreState:function(a){for(var h in a)this.originalTable.startIndex=b("#"+h).closest("th").prevAll().size()+1,this.originalTable.endIndex=parseInt(a[h]+1,10),this._bubbleCols()},_bubbleCols:function(){var a,b,c,f;a=this.originalTable.startIndex;var e=this.originalTable.endIndex,
g=this.originalTable.el.children();this.options.excludeFooter&&(g=g.not("tfoot"));if(a<e)for(;a<e;a++)for(c=g.find("> tr > td:nth-child("+a+")").add(g.find("> tr > th:nth-child("+a+")")),f=g.find("> tr > td:nth-child("+(a+1)+")").add(g.find("> tr > th:nth-child("+(a+1)+")")),b=0;b<c.length;b++)l(c[b],f[b]);else for(;a>e;a--)for(c=g.find("> tr > td:nth-child("+a+")").add(g.find("> tr > th:nth-child("+a+")")),f=g.find("> tr > td:nth-child("+(a-1)+")").add(g.find("> tr > th:nth-child("+(a-1)+")")),b=
0;b<c.length;b++)l(c[b],f[b])},_rearrangeTableBackroundProcessing:function(){var a=this;return function(){a._bubbleCols();a.options.beforeStop(this.originalTable);a.sortableTable.el.remove();b("#__dragtable_disable_text_selection__").remove();p?b(document.body).attr("onselectstart",p):b(document.body).removeAttr("onselectstart");q?b(document.body).attr("unselectable",q):b(document.body).removeAttr("unselectable");null!==a.options.persistState&&(b.isFunction(a.options.persistState)?a.options.persistState(a.originalTable):
a.persistState())}},_rearrangeTable:function(){var a=this;return function(){a.originalTable.selectedHandle.removeClass("dragtable-handle-selected");a.sortableTable.el.sortable("disable");a.sortableTable.el.addClass("dragtable-disabled");a.options.beforeReorganize(a.originalTable,a.sortableTable);a.originalTable.endIndex=a.sortableTable.movingRow.prevAll().size()+1;setTimeout(a._rearrangeTableBackroundProcessing(),50)}},_generateSortable:function(a){!a.cancelBubble&&(a.cancelBubble=!0);for(var h=this,
c=this.originalTable.el[0].attributes,f="",e=0;e<c.length;e++)c[e].nodeValue&&"id"!=c[e].nodeName&&"width"!=c[e].nodeName&&(f+=c[e].nodeName+'="'+c[e].nodeValue+'" ');var g=[],l=[];this.originalTable.el.find("tr").slice(0,this.options.maxMovingRows).each(function(a,d){for(var c=this.attributes,e="",f=0;f<c.length;f++)c[f].nodeValue&&"id"!=c[f].nodeName&&(e+=" "+c[f].nodeName+'="'+c[f].nodeValue+'"');g.push(e);l.push(b(this).height())});var m=[],n=0,k=h.originalTable.el.children();this.options.excludeFooter&&
(k=k.not("tfoot"));k.find("> tr > th").each(function(a,d){var c=b(this).outerWidth();m.push(c);n+=c+2});var d='<ul class="dragtable-sortable" style="position:absolute; width:'+n+'px;">';k.find("> tr > th").each(function(a,c){d+="<li>";d+="<table "+f+">";var e=k.find("> tr > th:nth-child("+(a+1)+")");1<h.options.maxMovingRows&&(e=e.add(k.find("> tr > td:nth-child("+(a+1)+")").slice(0,h.options.maxMovingRows-1)));e.each(function(a){var c=b(this).clone().wrap("<div></div>").parent().html();0===c.toLowerCase().indexOf("<th")&&
(d+="<thead>");d+="<tr "+g[a]+'" style="height:'+l[a]+'px;">';d+=c;0===c.toLowerCase().indexOf("<th")&&(d+="</thead>");d+="</tr>"});d+="</table>";d+="</li>"});d+="</ul>";this.sortableTable.el=this.originalTable.el.before(d).prev();this.sortableTable.el.find("> li > table").each(function(a,c){m[a]<b(this).width()&&(this.width=m[a]+"px")});this.sortableTable.selectedHandle=this.sortableTable.el.find("th .dragtable-handle-selected");this.sortableTable.el.sortable({items:this.options.dragaccept?"li:has("+
this.options.dragaccept+")":"li",stop:this._rearrangeTable(),revert:this.options.revert,tolerance:this.options.tolerance,containment:this.options.containment,cursor:this.options.cursor,cursorAt:this.options.cursorAt,distance:this.options.distance,axis:this.options.axis});this.originalTable.startIndex=b(a.target).closest("th").prevAll().size()+1;this.options.beforeMoving(this.originalTable,this.sortableTable);this.sortableTable.movingRow=this.sortableTable.el.find("li:nth-child("+this.originalTable.startIndex+
")");r();this.sortableTable.movingRow.trigger(b.extend(b.Event(a.type),{which:1,clientX:a.clientX,clientY:a.clientY,pageX:a.pageX,pageY:a.pageY,screenX:a.screenX,screenY:a.screenY}));a=this.sortableTable.el.find(".ui-sortable-placeholder");0>=!a.height()&&a.css("height",this.sortableTable.el.find(".ui-sortable-helper").height());a.html('<div class="outer" style="height:100%;"><div class="inner" style="height:100%;"></div></div>')},bindTo:{},_create:function(){this.originalTable={el:this.element,selectedHandle:b(),
sortOrder:{},startIndex:0,endIndex:0};this.bindTo=this.originalTable.el.find("th");this.options.dragaccept&&(this.bindTo=this.bindTo.filter(this.options.dragaccept));0<this.bindTo.find(this.options.dragHandle).size()&&(this.bindTo=this.bindTo.find(this.options.dragHandle));null!==this.options.restoreState&&(b.isFunction(this.options.restoreState)?this.options.restoreState(this.originalTable):this._restoreState(this.options.restoreState));var a=this;this.bindTo.mousedown(function(h){clearTimeout(this.downTimer);
this.downTimer=setTimeout(function(){a.originalTable.selectedHandle=b(this);a.originalTable.selectedHandle.addClass("dragtable-handle-selected");a.options.beforeStart(this.originalTable);a._generateSortable(h)},a.options.clickDelay)}).mouseup(function(a){clearTimeout(this.downTimer)})},destroy:function(){this.bindTo.unbind("mousedown");b.Widget.prototype.destroy.apply(this,arguments)}});var p=b(document.body).attr("onselectstart"),q=b(document.body).attr("unselectable")})(jQuery);